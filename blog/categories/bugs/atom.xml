<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: bugs | Aidan Ryan]]></title>
  <link href="http://www.aidanjryan.com/blog/categories/bugs/atom.xml" rel="self"/>
  <link href="http://www.aidanjryan.com/"/>
  <updated>2013-09-08T12:10:34-07:00</updated>
  <id>http://www.aidanjryan.com/</id>
  <author>
    <name><![CDATA[Aidan Ryan]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[SqlMetal bug with multi-rowset stored procedures]]></title>
    <link href="http://www.aidanjryan.com/blog/2012/08/25/sqlmetal-bug-with-multi-rowset-stored-procedures/"/>
    <updated>2012-08-25T15:54:00-07:00</updated>
    <id>http://www.aidanjryan.com/blog/2012/08/25/sqlmetal-bug-with-multi-rowset-stored-procedures</id>
    <content type="html"><![CDATA[<h3>The Issue:</h3>

<p>When a stored procedure has multiple result sets with the same column signature, only the first rowset with the given signature is included in the generated DBML.<!--more--></p>

<p>Consider the following three stored procedures:</p>

<p>```
CREATE PROCEDURE [GetOneWithLetters]
AS BEGIN
  SELECT 1 as [One], [Letter] FROM [dbo].[Letters]
END
GO</p>

<p>CREATE PROCEDURE [GetTwoWithLetters]
AS BEGIN
  SELECT 2 as [Two], [Letter] FROM [dbo].[Letters]
END
GO</p>

<p>CREATE PROCEDURE [BrokenInSqlMetal]
AS BEGIN</p>

<pre><code>exec [GetOneWithLetters]
exec [GetTwoWithLetters]
</code></pre>

<p>END
GO
```</p>

<p>The first two stored procedures return simple result sets. The third stored procedure returns two result sets by calling first two procedures.</p>

<p>The DBML generated by SqlMetal is:</p>

<p>```
&lt;?xml version="1.0" encoding="utf-8"?>
<Database Name="_Scratch" xmlns="http://schemas.microsoft.com/linqtosql/dbml/2007">
  <Table Name="dbo.Letters" Member="Letters"></p>

<pre><code>&lt;Type Name="Letters"&gt;
  &lt;Column Name="Letter" Type="System.String" DbType="Char(1)" CanBeNull="true" /&gt;
&lt;/Type&gt;
</code></pre>

<p>  </Table>
  <Function Name="dbo.BrokenInSqlMetal" Method="BrokenInSqlMetal" HasMultipleResults="true"></p>

<pre><code>&lt;ElementType Name="BrokenInSqlMetalResult"&gt;
  &lt;Column Name="One" Type="System.Int32" DbType="Int" CanBeNull="true" /&gt;
  &lt;Column Name="Letter" Type="System.String" DbType="Char(1)" CanBeNull="true" /&gt;
&lt;/ElementType&gt;
</code></pre>

<p>  </Function>
  <Function Name="dbo.GetOneWithLetters" Method="GetOneWithLetters"></p>

<pre><code>&lt;ElementType Name="GetOneWithLettersResult"&gt;
  &lt;Column Name="One" Type="System.Int32" DbType="Int" CanBeNull="true" /&gt;
  &lt;Column Name="Letter" Type="System.String" DbType="Char(1)" CanBeNull="true" /&gt;
&lt;/ElementType&gt;
</code></pre>

<p>  </Function>
  <Function Name="dbo.GetTwoWithLetters" Method="GetTwoWithLetters"></p>

<pre><code>&lt;ElementType Name="GetTwoWithLettersResult"&gt;
  &lt;Column Name="Two" Type="System.Int32" DbType="Int" CanBeNull="true" /&gt;
  &lt;Column Name="Letter" Type="System.String" DbType="Char(1)" CanBeNull="true" /&gt;
&lt;/ElementType&gt;
</code></pre>

<p>  </Function>
</Database>
```</p>

<p>Note that although the [BrokenInSqlMetal] procedure returns two result sets, only one result <ElementType> is generated. When the stored procedure is executed via a LINQ to SQL DataContext, and reults are retrieved by calling DataContext.GetResult<BrokenInSqlMetalResult> two times, the contents of the second result set are incorrect. The value of the One property (which should correspond to the [Two] column of the second stored proc) is not populated.</p>

<h3>Resolution:</h3>

<p>One fix is to swap the position of the columns in one of the rowsets. It also appears that adding a column alias to one of the child procedures will resolve the problem. Of course, this will likely require modifying the calling code at some layer of your application.</p>

<h3>Connect:</h3>

<p>I have posted this issue to Microsoft Connect. If it affects you, please visit and vote <a href="https://connect.microsoft.com/VisualStudio/feedback/details/759599/sqlmetal-omits-result-sets-from-stored-procedures-when-column-signatures-are-the-same">here</a>.</p>
]]></content>
  </entry>
  
</feed>
